# å·¥å…·ç³»ç»Ÿ

> v1.4.0 æ–°å¢ - å‚è€ƒ [Claude Agent SDK](https://platform.claude.com/docs/zh-CN/agent-sdk/overview) è®¾è®¡
> v1.5.0 å¢å¼º - å·¥å…·è°ƒç”¨ UI å±•ç¤ºã€æƒé™ç®¡ç†ã€æŒä¹…åŒ–å­˜å‚¨

å·¥å…·ç³»ç»Ÿæ˜¯ AI Desktop Assistant çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œè®© AI èƒ½å¤Ÿæ‰§è¡Œæ–‡ä»¶æ“ä½œã€æœç´¢ã€å‘½ä»¤æ‰§è¡Œç­‰å®é™…ä»»åŠ¡ã€‚

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Agentic Loop è°ƒç”¨æµç¨‹                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   ç”¨æˆ·è¾“å…¥ â”€â”€> Claude API â”€â”€> è§£æå“åº” â”€â”€> æœ‰å·¥å…·è°ƒç”¨?        â”‚
â”‚                                              â”‚               â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                              â†“                            â†“  â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                        â”‚ æƒé™æ£€æŸ¥  â”‚               â”‚ è¾“å‡ºæ–‡æœ¬ â”‚â”‚
â”‚                        â”‚ ask/allowâ”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                              â”‚                               â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚               â†“                             â†“               â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚        â”‚ allow: ç›´æ¥ â”‚               â”‚ ask: å†…è”  â”‚          â”‚
â”‚        â”‚ æ‰§è¡Œå·¥å…·    â”‚               â”‚ å¡ç‰‡ç¡®è®¤   â”‚          â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚               â”‚                             â”‚               â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                              â†“                              â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                   â”‚ ToolExecutor æ‰§è¡Œ    â”‚                   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                              â”‚                              â”‚
â”‚                              â†“                              â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                   â”‚ ç»“æœè¿”å› Claude API  â”‚                   â”‚
â”‚                   â”‚ ç»§ç»­ä¸‹ä¸€è½®å¯¹è¯       â”‚                   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                              â”‚                              â”‚
â”‚                              â†“                              â”‚
â”‚                     å¾ªç¯ç»§ç»­ (æœ€å¤š 10 æ¬¡)                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å†…ç½®å·¥å…·

| å·¥å…· | åŠŸèƒ½ | é»˜è®¤æƒé™ |
|------|------|----------|
| `read_file` | è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒæŒ‡å®šè¡ŒèŒƒå›´ | âœ… å…è®¸ |
| `write_file` | åˆ›å»ºæˆ–è¦†ç›–æ–‡ä»¶ | âš ï¸ éœ€ç¡®è®¤ |
| `edit_file` | ç²¾ç¡®å­—ç¬¦ä¸²æ›¿æ¢ç¼–è¾‘ | âš ï¸ éœ€ç¡®è®¤ |
| `list_directory` | åˆ—å‡ºç›®å½•å†…å®¹ | âœ… å…è®¸ |
| `search_files` | Glob æ¨¡å¼æœç´¢æ–‡ä»¶è·¯å¾„ | âœ… å…è®¸ |
| `grep_search` | æ­£åˆ™è¡¨è¾¾å¼æœç´¢æ–‡ä»¶å†…å®¹ | âœ… å…è®¸ |
| `run_command` | æ‰§è¡Œ Shell å‘½ä»¤ | âš ï¸ éœ€ç¡®è®¤ |
| `web_fetch` | è·å–ç½‘é¡µå†…å®¹ | âœ… å…è®¸ |
| `get_system_info` | è·å–ç³»ç»Ÿä¿¡æ¯ | âœ… å…è®¸ |

## å·¥å…·è°ƒç”¨ UI (v1.5.0)

### å¯æŠ˜å å¡ç‰‡å±•ç¤º

å·¥å…·è°ƒç”¨ä»¥å¯æŠ˜å å¡ç‰‡å½¢å¼ç©¿æ’æ˜¾ç¤ºåœ¨å¯¹è¯æµä¸­ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–¶ ğŸ“ åˆ—å‡ºç›®å½•  /Users/xxx/project         âœ…   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥å‚æ•°                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ { "path": "/Users/xxx/project" }          â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ è¾“å‡ºç»“æœ                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ src/                                      â”‚  â”‚
â”‚ â”‚ package.json                              â”‚  â”‚
â”‚ â”‚ ...                                       â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€æŒ‡ç¤º

| çŠ¶æ€ | å›¾æ ‡ | è¯´æ˜ |
|------|------|------|
| pending | âš ï¸ é»„è‰² | ç­‰å¾…ç”¨æˆ·ç¡®è®¤ |
| running | ğŸ”„ è“è‰² | æ­£åœ¨æ‰§è¡Œä¸­ |
| success | âœ… ç»¿è‰² | æ‰§è¡ŒæˆåŠŸ |
| error | âŒ çº¢è‰² | æ‰§è¡Œå¤±è´¥ |

### Agentic Loop ç©¿æ’æ¸²æŸ“

AI è¾“å‡ºæŒ‰çœŸå®é¡ºåºå±•ç¤ºï¼Œæ–‡å­—å’Œå·¥å…·è°ƒç”¨äº¤æ›¿ç©¿æ’ï¼š

```
AI: è®©æˆ‘å¸®ä½ åˆ†æè¿™ä¸ªé¡¹ç›®ç»“æ„ã€‚
   [ğŸ“ åˆ—å‡ºç›®å½• /project âœ…]
AI: é¡¹ç›®åŒ…å«ä»¥ä¸‹ä¸»è¦æ–‡ä»¶ï¼š
   [ğŸ“„ è¯»å–æ–‡ä»¶ package.json âœ…]
AI: è¿™æ˜¯ä¸€ä¸ª Node.js é¡¹ç›®ï¼Œè®©æˆ‘æ£€æŸ¥æºç ...
```

## æƒé™ç³»ç»Ÿ (v1.5.0 å¢å¼º)

### ä¸‰çº§æƒé™

| æƒé™ | è¯´æ˜ | ç”¨æˆ·äº¤äº’ |
|------|------|----------|
| `allow` | è‡ªåŠ¨å…è®¸ | æ—  |
| `ask` | éœ€è¦ç¡®è®¤ | å†…è”å¡ç‰‡ç¡®è®¤ |
| `deny` | ç¦æ­¢ä½¿ç”¨ | ç›´æ¥æ‹’ç» |

### è®¾ç½®ç•Œé¢é…ç½®

åœ¨è®¾ç½®ä¸­å¯ä»¥è‡ªå®šä¹‰å·¥å…·æƒé™ï¼Œå‹¾é€‰çš„å·¥å…·ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥å…·æƒé™                                â”‚
â”‚                                         â”‚
â”‚ â˜‘ è¯»å–æ–‡ä»¶     â˜ å†™å…¥æ–‡ä»¶     â˜ ç¼–è¾‘æ–‡ä»¶ â”‚
â”‚ â˜‘ åˆ—å‡ºç›®å½•     â˜‘ æœç´¢æ–‡ä»¶     â˜‘ å†…å®¹æœç´¢ â”‚
â”‚ â˜ æ‰§è¡Œå‘½ä»¤     â˜‘ è·å–ç½‘é¡µ     â˜‘ ç³»ç»Ÿä¿¡æ¯ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼šè¯çº§å¿«æ·ç¡®è®¤ (v1.5.0)

ä¸ºè§£å†³å¤šæ¬¡å·¥å…·è°ƒç”¨éœ€è¦å¤šæ¬¡ç¡®è®¤çš„é—®é¢˜ï¼Œæä¾›ä¸‰ç§ç¡®è®¤æ–¹å¼ï¼š

| æŒ‰é’® | åŠŸèƒ½ |
|------|------|
| **å…è®¸** | ä»…å…è®¸æœ¬æ¬¡å·¥å…·è°ƒç”¨ |
| **æœ¬æ¬¡ä¼šè¯å…è®¸è¯¥å·¥å…·** | æœ¬æ¬¡ä¼šè¯ä¸­è¯¥ç±»å‹å·¥å…·è‡ªåŠ¨æ‰§è¡Œ |
| **æœ¬æ¬¡ä¼šè¯å…è®¸æ‰€æœ‰** | æœ¬æ¬¡ä¼šè¯ä¸­æ‰€æœ‰å·¥å…·è‡ªåŠ¨æ‰§è¡Œ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–¶ âš ï¸ éœ€è¦ç¡®è®¤ æ‰§è¡Œå‘½ä»¤  npm run build          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥å‚æ•°                                        â”‚
â”‚ { "command": "npm run build" }                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ›¡ æœ¬æ¬¡ä¼šè¯å…è®¸è¯¥å·¥å…·  ğŸ›¡ï¸ æœ¬æ¬¡ä¼šè¯å…è®¸æ‰€æœ‰      â”‚
â”‚                         [ å–æ¶ˆ ] [ å…è®¸ ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¶…æ—¶è®¾ç½®

- é»˜è®¤è¶…æ—¶ï¼š**5 åˆ†é’Ÿ**ï¼ˆ300 ç§’ï¼‰
- è¶…æ—¶åè‡ªåŠ¨æ‹’ç»æ‰§è¡Œ
- ç»™ç”¨æˆ·å……è¶³æ—¶é—´å†³å®šæ˜¯å¦å…è®¸

## å·¥å…·è°ƒç”¨æŒä¹…åŒ– (v1.5.0)

### æ•°æ®ç»“æ„

æ¶ˆæ¯æ”¯æŒ `items` å­—æ®µå­˜å‚¨å·¥å…·è°ƒç”¨è®°å½•ï¼š

```typescript
interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;           // çº¯æ–‡æœ¬å†…å®¹ï¼ˆå‘åå…¼å®¹ï¼‰
  items?: MessageItem[];     // ç©¿æ’çš„æ–‡å­—å’Œå·¥å…·è°ƒç”¨
  timestamp?: number;
}

type MessageItem = 
  | { type: 'text'; content: string }
  | { type: 'tool'; toolCall: ToolCallRecord };

interface ToolCallRecord {
  id: string;
  name: string;
  input: Record<string, unknown>;
  status: 'pending' | 'running' | 'success' | 'error';
  output?: string;
  error?: string;
}
```

### SQLite å­˜å‚¨

- `items` æ•°æ®ä½¿ç”¨ **gzip å‹ç¼©** å­˜å‚¨åˆ° `messages.items_data` BLOB åˆ—
- å‹ç¼©å¯æ˜¾è‘—å‡å°‘å­˜å‚¨ç©ºé—´ï¼ˆJSON æ–‡æœ¬å‹ç¼©ç‡çº¦ 70-80%ï¼‰
- åˆ‡æ¢ä¼šè¯æ—¶è‡ªåŠ¨è§£å‹å¹¶æ¢å¤å®Œæ•´çš„å·¥å…·è°ƒç”¨ UI

```sql
CREATE TABLE messages (
  id INTEGER PRIMARY KEY,
  session_id TEXT NOT NULL,
  role TEXT NOT NULL,
  content TEXT NOT NULL,
  items_data BLOB,        -- gzip å‹ç¼©çš„ items JSON
  timestamp INTEGER NOT NULL
);
```

## æ ¸å¿ƒä»£ç 

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `src/tool-executor.ts` | å·¥å…·å®šä¹‰å’Œæ‰§è¡Œå®ç° |
| `src/claude-service.ts` | Agentic Loop ä¸»é€»è¾‘ã€items æ”¶é›† |
| `src/session-storage.ts` | æ¶ˆæ¯å­˜å‚¨ã€gzip å‹ç¼©/è§£å‹ |
| `src/renderer/components/ToolCallBlock.tsx` | å·¥å…·è°ƒç”¨å¡ç‰‡ç»„ä»¶ |
| `src/renderer/stores/chat-store.ts` | æµå¼å†…å®¹ç®¡ç†ã€æƒé™ç¡®è®¤ |
| `src/renderer/stores/config-store.ts` | å·¥å…·æƒé™é…ç½® |

## å·¥å…·å®šä¹‰æ ¼å¼

éµå¾ª Anthropic Tool Use è§„èŒƒï¼š

```typescript
interface ToolDefinition {
  name: string;
  description: string;
  input_schema: {
    type: 'object';
    properties: Record<string, { type: string; description: string }>;
    required?: string[];
  };
  permission: 'allow' | 'ask' | 'deny';
}
```

## è°ƒç”¨æµç¨‹è¯¦è§£

### 1. æ³¨å†Œå·¥å…·åˆ° Claude API

```typescript
// claude-service.ts
const tools = this.toolExecutor.getToolDefinitions();
const stream = client.messages.stream({
  model: this.config.model,
  messages,
  tools,  // å‘Šè¯‰ Claude å¯ç”¨å·¥å…·
});
```

### 2. è§£æ AI çš„å·¥å…·è°ƒç”¨è¯·æ±‚

Claude è¿”å›çš„å“åº”ä¸­åŒ…å« `tool_use` ç±»å‹çš„å†…å®¹å—ï¼š

```typescript
if (event.content_block.type === 'tool_use') {
  currentToolName = event.content_block.name;  // å¦‚ "edit_file"
  currentToolInput = ...;  // å‚æ•° JSON
}
```

### 3. æ‰§è¡Œå·¥å…·

```typescript
const result = await this.toolExecutor.executeTool(toolUse.name, toolUse.input);
```

### 4. è¿”å›ç»“æœç»™ Claude

```typescript
toolResults.push({
  type: 'tool_result',
  tool_use_id: toolUse.id,
  content: result.output,
  is_error: !result.success,
});
messages.push({ role: 'user', content: toolResults });
// ç»§ç»­ä¸‹ä¸€è½®å¯¹è¯
```

## é…ç½®é¡¹

```typescript
// claude-service.ts
const MAX_TOOL_ITERATIONS = 10;  // æœ€å¤§å·¥å…·è°ƒç”¨å¾ªç¯æ¬¡æ•°

// main.ts
const TOOL_APPROVAL_TIMEOUT = 300000;  // 5 åˆ†é’Ÿè¶…æ—¶
```

## ç›¸å…³æ–‡æ¡£

- [Claude Agent SDK å®˜æ–¹æ–‡æ¡£](https://platform.claude.com/docs/zh-CN/agent-sdk/overview)
- [äº§å“è·¯çº¿å›¾ - å·¥å…·ç³»ç»Ÿ](../roadmap.md#é˜¶æ®µä¸€-å·¥å…·ç³»ç»Ÿ-v14----å·²å®Œæˆ)
